<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AetherWave — Global Playlist Player</title>
<style>
  :root{--bg:#0b0b12;--ink:#eef1ff;--muted:#bfc1d3;--accent:#ff2fa6;--accent2:#35d0ff;--panel:#141428;--br:16px}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(900px 600px at 90% -10%,rgba(255,47,166,.12),transparent 40%),radial-gradient(700px 500px at -10% 110%,rgba(53,208,255,.10),transparent 40%),linear-gradient(180deg,#0a0a12,#0a0a11);color:var(--ink);font-family:Inter,system-ui,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
  h1{margin:0;font-size:18px}
  .wrap{max-width:920px;margin:0 auto;padding:0 12px 28px}
  .player{display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width: 900px){.player{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--br);padding:14px}
  .list{max-height:60vh;overflow:auto}
  .track{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;padding:8px;border-radius:12px;cursor:pointer}
  .track:hover{background:#0f0f1c}
  .track.active{outline:1px solid rgba(255,255,255,.18);background:#0f0f1c}
  .cover{width:56px;height:56px;border-radius:10px;background:#1a1a2a;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .cover img{width:100%;height:100%;object-fit:cover}
  .meta{display:flex;flex-direction:column;gap:2px}
  .title{font-weight:600}
  .artist{font-size:12px;color:var(--muted)}
  .dur{font-size:12px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:1fr;gap:10px}
  .row{display:flex;gap:10px;align-items:center}
  button{padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,47,166,.25),rgba(53,208,255,.15));color:#fff;cursor:pointer}
  button.ghost{background:#0f0f1c}
  input[type="range"]{width:100%}
  .seek{display:flex;align-items:center;gap:8px}
  .time{font-size:12px;color:var(--muted);width:64px;text-align:center}
  .admin{position:fixed;inset:auto 12px 12px auto;max-width:380px;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none}
  .admin.show{display:block}
  .admin label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  .admin .row{margin-top:8px}
  .badge{padding:4px 8px;border-radius:999px;background:#0f0f1c;border:1px solid rgba(255,255,255,.15);font-size:12px;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f0f1c;border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;font-size:13px;color:var(--muted);display:none}
</style>
</head>
<body>
  <header>
    <h1>AetherWave — Global Playlist</h1>
    <div class="row">
      <span id="count" class="badge">0 tracks</span>
      <button id="btnAdmin" class="ghost" title="Open Admin (Ctrl+.)">Admin</button>
    </div>
  </header>

  <div class="wrap">
    <div class="player">
      <div class="card"><div class="list" id="list"></div></div>
      <div class="card">
        <div class="controls">
          <div class="row">
            <button id="prev">⏮</button>
            <button id="play">▶️</button>
            <button id="next">⏭</button>
            <button id="shuffle" class="ghost">Shuffle</button>
            <button id="repeat" class="ghost">Repeat: Off</button>
            <button id="share" class="ghost">Share</button>
          </div>
          <div class="seek">
            <span class="time" id="cur">0:00</span>
            <input id="seek" type="range" min="0" max="1000" value="0" step="1"/>
            <span class="time" id="dur">0:00</span>
          </div>
          <div class="row">
            <label style="font-size:12px;color:var(--muted)">Vol</label>
            <input id="vol" type="range" min="0" max="1" step="0.01"/>
          </div>
        </div>
        <audio id="audio"></audio>
      </div>
    </div>
  </div>

  <div id="admin" class="admin" role="dialog" aria-label="Admin">
    <strong>Admin</strong>
    <label>Remote playlist URL</label>
    <input id="remoteUrl" placeholder="https://.../playlist.json OR .../exec?route=playlist&callback=awp" style="width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f0f1c;color:#fff"/>
    <div class="row">
      <button id="load">Load Remote</button>
      <button id="save" class="ghost">Save as default</button>
      <button id="clear" class="ghost">Clear</button>
    </div>
    <label><input type="checkbox" id="showPrivate"> Show private (adds &admin=1)</label>
    <div class="fine" style="font-size:12px;color:var(--muted);margin-top:8px">Tip: If CORS blocks fetch, append <code>&callback=awp</code> for JSONP, or host <code>playlist.json</code> next to this file.</div>
  </div>

  <div id="toast" class="toast"></div>

<script>
(function(){
  const ls = (k,v)=> (v===undefined? localStorage.getItem(k): (localStorage.setItem(k,v),v));
  const ss = (k,v)=> (v===undefined? sessionStorage.getItem(k): (sessionStorage.setItem(k,v),v));
  const $ = id=>document.getElementById(id);
  const fmt = s=>{s=Math.floor(s||0);const m=Math.floor(s/60),sec=('0'+(s%60)).slice(-2);return m+':'+sec};

  const audio = $('audio');
  const listEl = $('list');
  const seek = $('seek');
  const vol = $('vol');
  const cur = $('cur');
  const dur = $('dur');
  const btnPlay = $('play');
  const btnPrev = $('prev');
  const btnNext = $('next');
  const btnShuffle = $('shuffle');
  const btnRepeat = $('repeat');
  const btnShare = $('share');
  const count = $('count');
  const admin = $('admin');
  const btnAdmin = $('btnAdmin');
  const remoteUrl = $('remoteUrl');
  const showPrivate = $('showPrivate');
  const btnLoad = $('load');
  const btnSave = $('save');
  const btnClear = $('clear');
  const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); };

  let tracks = []; let idx = -1; let shuffle=false; let repeat=0; // 0 off,1 all,2 one

  // restore settings
  vol.value = ls('awp:vol') || 0.9; audio.volume = parseFloat(vol.value);
  shuffle = ls('awp:shuffle')==='1'; btnShuffle.classList.toggle('active', shuffle);
  repeat = parseInt(ls('awp:repeat')||'0',10); btnRepeat.textContent = ['Repeat: Off','Repeat: All','Repeat: One'][repeat];
  remoteUrl.value = ls('awp:remotePlaylist') || '';
  if (new URLSearchParams(location.search).get('admin')==='1') admin.classList.add('show');

  // helpers
  function setSrc(t){ if(!t) return; audio.src = t.url; audio.play().catch(()=>{}); btnPlay.textContent='⏸'; }

  function render(){
    listEl.innerHTML='';
    tracks.forEach((t,i)=>{
      const row=document.createElement('div'); row.className='track'+(i===idx?' active':''); row.dataset.i=i;
      const cov=document.createElement('div'); cov.className='cover'; cov.innerHTML = `<img alt="" src="${t.cover||''}">`;
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div class="title">${t.title||'Untitled'}</div><div class="artist">${t.artist||''}</div>`;
      const d=document.createElement('div'); d.className='dur'; d.textContent = t.duration?fmt(t.duration):'';
      row.append(cov,meta,d); listEl.appendChild(row);
    });
    count.textContent = tracks.length+ (tracks.length===1?' track':' tracks');
  }

  function select(i){ if(i<0||i>=tracks.length) return; idx=i; render(); setSrc(tracks[idx]); ls('awp:lastTrackId', tracks[idx].id || ''); }

  // events
  listEl.addEventListener('click', (e)=>{ const row=e.target.closest('.track'); if(!row) return; select(parseInt(row.dataset.i,10)); });
  btnPlay.addEventListener('click', ()=>{ if(audio.paused){audio.play(); btnPlay.textContent='⏸';} else {audio.pause(); btnPlay.textContent='▶️';} });
  btnPrev.addEventListener('click', ()=>{ select(Math.max(0, idx-1)); });
  btnNext.addEventListener('click', next);
  btnShuffle.addEventListener('click', ()=>{ shuffle=!shuffle; ls('awp:shuffle', shuffle?'1':'0'); btnShuffle.classList.toggle('active', shuffle); });
  btnRepeat.addEventListener('click', ()=>{ repeat=(repeat+1)%3; ls('awp:repeat', String(repeat)); btnRepeat.textContent=['Repeat: Off','Repeat: All','Repeat: One'][repeat]; });
  btnShare.addEventListener('click', ()=>{
    if(idx<0) return; const t=tracks[idx]; const u=new URL(location.href); u.searchParams.set('track', t.id||idx); u.searchParams.set('t', Math.floor(audio.currentTime)); navigator.clipboard.writeText(u.toString()); toast('Link copied');
  });
  seek.addEventListener('input', ()=>{ if(audio.duration){ audio.currentTime = (seek.value/1000)*audio.duration; }});
  audio.addEventListener('timeupdate', ()=>{ if(audio.duration){ seek.value = Math.floor((audio.currentTime/audio.duration)*1000); cur.textContent=fmt(audio.currentTime); }});
  audio.addEventListener('loadedmetadata', ()=>{ dur.textContent=fmt(audio.duration); });
  audio.addEventListener('ended', ()=>{
    if(repeat===2){ audio.currentTime=0; audio.play(); return; }
    next();
  });
  vol.addEventListener('input', ()=>{ audio.volume=parseFloat(vol.value); ls('awp:vol', vol.value); });

  function next(){
    if(shuffle){ select(Math.floor(Math.random()*tracks.length)); return; }
    const n = idx+1; if(n<tracks.length){ select(n); } else if(repeat===1){ select(0); } else { btnPlay.textContent='▶️'; }
  }

  // Admin
  function toggleAdmin(force){ admin.classList.toggle('show', force!==undefined?force:!admin.classList.contains('show')); }
  btnAdmin.addEventListener('click', ()=> toggleAdmin());
  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key=='.'){ e.preventDefault(); toggleAdmin(); } });

  btnSave.addEventListener('click', ()=>{ if(remoteUrl.value){ ls('awp:remotePlaylist', remoteUrl.value); toast('Saved'); }});
  btnClear.addEventListener('click', ()=>{ localStorage.removeItem('awp:remotePlaylist'); toast('Cleared'); });

  btnLoad.addEventListener('click', async ()=>{ if(!remoteUrl.value) return; await loadPlaylistFromUrl(remoteUrl.value, true); });

  showPrivate.addEventListener('change', ()=>{ sessionStorage.setItem('awp:private', showPrivate.checked?'1':'0'); toast('Private '+(showPrivate.checked?'on':'off')); });

  // loader with JSONP support + same-origin JSON
  async function loadPlaylistFromUrl(url, andRender){
    let u;
    try{ u = new URL(url, location.href); }catch{ toast('Bad URL'); return; }

    if(sessionStorage.getItem('awp:private')==='1'){ u.searchParams.set('admin','1'); }

    // Same-origin JSON is simplest
    const isSameOrigin = u.origin === location.origin;
    const hasCallback = u.searchParams.has('callback');

    if (!isSameOrigin && hasCallback){ // JSONP path
      await new Promise((resolve,reject)=>{
        const cb='awp_cb_'+Math.random().toString(36).slice(2);
        u.searchParams.set('callback', cb);
        const s=document.createElement('script');
        window[cb]=(data)=>{ try{ applyPlaylist(data); if(andRender){render(); selectInitial();} toast('Playlist loaded'); resolve(); } catch(e){ reject(e);} finally{ delete window[cb]; s.remove(); } };
        s.onerror=()=>{ delete window[cb]; s.remove(); toast('Failed to load playlist'); reject(new Error('JSONP failed')); };
        s.src=u.toString(); document.head.appendChild(s);
      });
      return;
    }

    try{
      const res = await fetch(u.toString());
      const data = await res.json();
      applyPlaylist(data);
      if(andRender){ render(); selectInitial(); }
      toast('Playlist loaded');
    }catch(e){ console.error(e); toast('Fetch failed'); }
  }

  function applyPlaylist(data){
    tracks = Array.isArray(data?.tracks)? data.tracks : [];
    tracks = tracks.map((t,i)=>({ id: t.id || String(i), title: t.title||'Untitled', artist: t.artist||'', url: t.url, cover: t.cover||'', duration: Number(t.duration||0) }))
                   .filter(t=> !!t.url);
  }

  function selectInitial(){
    const p=new URLSearchParams(location.search);
    const tid=p.get('track'); const at = parseInt(p.get('t')||'0',10);
    let i=0; if(tid){ i = tracks.findIndex(t=> (t.id||'')===tid); if(i<0) i=0; }
    select(i); if(at>0 && audio.duration){ audio.currentTime=Math.min(at, audio.duration-1); }
  }

  // boot
  (async function(){
    const q = new URLSearchParams(location.search);
    const qUrl = q.get('playlist');
    const saved = ls('awp:remotePlaylist');
    if(qUrl){ remoteUrl.value=qUrl; }
    else if(saved){ remoteUrl.value=saved; }

    if(remoteUrl.value){ await loadPlaylistFromUrl(remoteUrl.value, true); }
  })();
})();
</script>
<script>
  // Load playlist.json fresh each time
  fetch('playlist.json?v=' + Date.now())
    .then(r => r.json())
    .then(data => {
      console.log("Loaded playlist:", data);
      // TODO: replace this with your real render function
      // Example: renderTracks(data.tracks);
    })
    .catch(err => {
      console.error("Error loading playlist.json", err);
    });
</script>

  
</body>
</html>
